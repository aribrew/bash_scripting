#!/bin/bash

if ! [[ -v BASH_HELPERS_LOADED ]];
then
    source bash_helpers.sh
fi


if ! [[ -v BASH_HELPERS_LOADED ]];
then
    echo -e "Please add bash_helpers.sh to your PATH.\n"
    exit 1
fi


sudo apt-get autoremove --dry-run > /tmp/to_remove

FILE="/tmp/to_remove"

cat "$FILE" | grep "Remv " > /tmp/to_remove.clean

FILE="/tmp/to_remove.clean"


if ! [[ "$FILE" == "" ]] && [[ -f "$FILE" ]];
then
    PACKAGES=""
    
    echo "Processing '$FILE' for packages marked for auto-remove..."

    FILE_CONTENTS=$(cat "$FILE")

    if [[ "$FILE_CONTENTS" == "" ]];
    then
        abort "Something is wrong. The '$FILE' generated file is empty."
    fi

    while IFS= read -r entry;
    do  
        PACKAGE=$(echo "$entry" | cut -d ' ' -f 2)

        if ! [[ "$PACKAGE" == "" ]];
        then
            PACKAGES+="$PACKAGE "
        fi
    done < "$FILE"

    if ! [[ "$PACKAGES" == "" ]];
    then
        echo -e "\nMarking packages '$PACKAGES' as manually installed\n."
        ask_yn "Proceed?"

        echo ""
        
        if [[ "$?" == "0" ]];
        then
            sudo apt-mark manual $PACKAGES
        fi
    fi
fi
